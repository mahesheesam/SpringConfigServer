db.paymentPrefVersions.aggregate([
  {
    // Match paymentPrefVersions based on lastUpdateDate
    $match: {
      lastUpdateDate: { $gt: ISODate("2024-01-01T00:00:00Z") } // Replace with your required date
    }
  },
  {
    // Lookup matching paymentPreferences based on uniquePrefKey
    $lookup: {
      from: "paymentPreferences", // paymentPreferences collection
      localField: "uniquePrefKey", // uniquePrefKey in paymentPrefVersions
      foreignField: "uniquePrefKey", // matching field in paymentPreferences
      as: "paymentPreferences"
    }
  },
  {
    // Unwind the array to get individual records
    $unwind: "$paymentPreferences"
  },
  {
    // Lookup accounts based on uniquePrefKey
    $lookup: {
      from: "accounts", // accounts collection
      localField: "uniquePrefKey", // uniquePrefKey from paymentPrefVersions
      foreignField: "uniquePrefKey", // uniquePrefKey in accounts collection
      as: "accounts"
    }
  },
  {
    // Project the required fields, including corphubId, connectivityType, and clientIdConn from paymentPreferences
    $project: {
      _id: 0, // Exclude _id
      uniquePrefKey: 1, // Include uniquePrefKey
      lastUpdateDate: 1, // Include lastUpdateDate
      "paymentPreferences.corphubId": 1, // Include corphubId from paymentPreferences
      "paymentPreferences.connectivityType": 1, // Include connectivityType from paymentPreferences
      "paymentPreferences.clientIdConn": 1, // Include clientIdConn from paymentPreferences
      accounts: 1 // Include matched accounts
    }
  }
])
